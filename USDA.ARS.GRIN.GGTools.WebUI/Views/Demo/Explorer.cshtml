@model USDA.ARS.GRIN.GGTools.ViewModelLayer.TaxonomyExplorerViewModel
@{
    ViewBag.Title = "Navigator";
    Layout = "~/Views/Shared/_LayoutAdminLTE3.cshtml";
}

<style>
    #section-hierarchical-list .card-body {
        padding: .25rem;
    }
</style>

<div class="row">
    <div id="section-hierarchical-list" class="col-md-3">
        <div class="form-group">
            <label>Select Display Level</label>
            <select id="ddlHierarchicalLevel" class="form-control">
                <option>Family</option>
                <option>Genus</option>
                <option>Species</option>
            </select>
        </div>
        @foreach (var result in Model.DataCollectionGenus)
        {
            <div class="card card-success collapsed-card">
                <div class="card-header">
                    <h3 class="card-title">@result.Name</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" style="display:none;">
                    <div id="section-species-list" class="list-group">
                        @{ Html.RenderAction("_List", "Species", new { genusId = result.ID, formatCode = "S" }); }
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="col-md-9">

        <div id="section-unsaved-changes" style="display:none;" class="alert alert-warning alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
            <h5><i class="icon fas fa-exclamation-triangle"></i> Alert!</h5>
            Warning alert preview. This alert is dismissable.
        </div>

        <div class="card card-default">
            <div class="card-header">
                <h3 class="card-title">Details</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div id="section-species-detail" class="card-body">

            </div>
            <div class="card-footer">
                <button id="btnSave" type="button" class="btn btn-info">Save</button>
            </div>
        </div>
        <div id="section-species-citations">
        </div>
        <div id="section-species-common-names">
        </div>
        <div id="section-species-distributions">
        </div>
    </div>
</div>

<script type="text/javascript">

    $(document).ready(function () {
        InitDataTableByClass();
    });

    $('#section-species-list ul.nav li').on('click', function () {
        var selectedSpeciesId = $(this).attr('id');
        var selectedGenusId = $(this).data("ggtools-value");
        var genusNodeId = "#list-taxa-" + selectedGenusId;

        //DEBUG
        if ($('.changed-input').length) {
            alert("DEBUG UNSAVED CHANGES");
        }
        else {
            if (selectedSpeciesId == -9) {
                //Add(selectedGenusId);

                //TODO 
                // 1) Refresh genus node to show newly - added species
                alert("DEBUG " + genusNodeId);
                $(genusNodeId).append("<li><h4>DEBUG/h4)</li>");

                // 2) Refresh species edit page and allow add of child data
            }
            else {
                Edit(selectedSpeciesId);
                LoadCommonNames(selectedSpeciesId);
                LoadDistributions(selectedSpeciesId);
            }
        }
    });

    $('#btnSave').on('click', function () {
        AjaxFormSubmit();
    });

    function Add(genusId) {
        link = '@Url.Action("_Add","Species")';
        var formData = new FormData();

        try {
            formData.append("genusId", genusId);
            $.ajax({
                url: link,
                type: 'POST',
                cache: false,
                contentType: false,
                processData: false,
                data: formData,
                success: function (response) {
                    $("#section-species-detail").html(response);
                }
            });
        }
        catch (exception) {

        }
    }

    function Edit(speciesId) {
        link = '@Url.Action("_Edit","Species")';
        var formData = new FormData();

        try {
            formData.append("entityId", speciesId);
            $.ajax({
                url: link,
                type: 'POST',
                cache: false,
                contentType: false,
                processData: false,
                data: formData,
                success: function (response) {
                    $("#section-species-detail").html(response);
                }
            });
        }
        catch (exception) {

        }
    }

    function LoadCitations(speciesId) {
        link = '@Url.Action("_List","Citation")';
        var formData = new FormData();

        formData.append("SpeciesID", speciesId);
        formData.append("FormatCode", "1");

        $.ajax({
            url: link,
            type: 'POST',
            cache: false,
            contentType: false,
            processData: false,
            data: formData,
            success: function (response) {
                $("#section-species-citations").html(response);
            }
        });
    }

    function LoadCommonNames(speciesId) {
        link = '@Url.Action("_List","CommonName")';
        var formData = new FormData();

        formData.append("speciesId", speciesId);

        $.ajax({
            url: link,
            type: 'POST',
            cache: false,
            contentType: false,
            processData: false,
            data: formData,
            success: function (response) {
                $("#section-species-common-names").html(response);
            }
        });
    }

    function LoadDistributions(speciesId) {
        link = '@Url.Action("_List","GeographyMap")';
        var formData = new FormData();

        formData.append("entityId", speciesId);

        $.ajax({
            url: link,
            type: 'POST',
            cache: false,
            contentType: false,
            processData: false,
            data: formData,
            success: function (response) {
                $("#section-species-distributions").html(response);
            }
        });
    }

    function LoadDependentData(sectionId) {
        var link = "";
        var entityId = $("#Entity_ID").val();
        var genusId = $("#Entity_GenusID").val();
        var genusName = $("#Entity_Name").val();
        var formData = new FormData();
        var sectionData = sectionId.replace("tab_selector", "tab_content");

        // Load data in selected section content area based on id.
        switch (sectionId) {
            case "tab_selector_citations":
                link = '@Url.Action("_List","Citation")';
                break;
            case "tab_selector_species":
                link = '@Url.Action("_List","Species")';
                break;
            case "tab_selector_synonyms":
                link = '@Url.Action("_ListSynonyms", "Genus")';
                break;
            case "tab_selector_subdivisions":
                link = '@Url.Action("_ListSubdivisions", "Genus", new { genusName = "GENUS_NAME" })';
                link = link.replace("GENUS_NAME", genusName);
                break;
            default:
                // code block
        }

    formData.append("GenusID", entityId);

    $.ajax({
        url: link,
        type: 'POST',
        cache: false,
        contentType: false,
        processData: false,
        data: formData,
        success: function (response) {
            $("#" + sectionData).html(response);
        }
    });
    }

    function AjaxFormSubmit() {
        //Set the URL.
        var url = $("#frmEdit").attr("action");

        //Add the Field values to FormData object.
        var formData = new FormData();
        formData.append("Entity.ID", $("#Entity_ID").val());
        formData.append("Entity.GenusID", $("#Entity_GenusID").val());
        formData.append("Entity.Rank", $("#Entity_Rank").val());
        formData.append("Entity.SpeciesName", $("#Entity_SpeciesName").val());
        formData.append("Entity.Note", $("#Entity_Note").val());

        $.ajax({
            type: 'POST',
            url: url,
            data: formData,
            processData: false,
            contentType: false
        }).done(function (response) {
            if (response) {
                //alert("Form submitted!");
            }
            else {
                //alert("Invalid Form data!");
            }
        });
    }

    

</script>
